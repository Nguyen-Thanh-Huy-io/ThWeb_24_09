<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>CRUD User/Product/Category (GraphQL + AJAX)</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        header {
            background: #007bff;
            color: #fff;
            padding: 24px 0 16px 0;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        header h1 {
            margin: 0;
            font-size: 2.5rem;
            letter-spacing: 1px;
        }
        main {
            max-width: 1100px;
            margin: 32px auto 32px auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.07);
            padding: 32px 24px 24px 24px;
        }
        section {
            margin-bottom: 40px;
        }
        h2 {
            color: #007bff;
            margin-bottom: 12px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 12px;
            background: #fafbfc;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        th, td {
            border: 1px solid #e3e6ea;
            padding: 10px 8px;
            text-align: left;
        }
        th {
            background: #e9ecef;
            font-weight: 700;
        }
        tr:nth-child(even) { background: #f4f6f8; }
        input, button {
            margin: 4px 8px 4px 0;
            padding: 7px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        input:focus {
            outline: 2px solid #007bff;
        }
        button {
            background: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #0056b3;
        }
        .action-btn {
            background: #dc3545;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 4px;
        }
        .action-btn:hover {
            background: #b52a37;
        }
        footer {
            background: #222;
            color: #fff;
            text-align: center;
            padding: 18px 0 12px 0;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            position: relative;
            bottom: 0;
            width: 100%;
        }
        @media (max-width: 700px) {
            main { padding: 10px; }
            th, td { font-size: 0.95rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Quản lý User, Product, Category (GraphQL + AJAX)</h1>
    </header>
    <main>
        <section>
            <h2>CRUD User</h2>
            <div>
                <input id="fullname" placeholder="Fullname">
                <input id="email" placeholder="Email">
                <input id="password" placeholder="Password">
                <input id="phone" placeholder="Phone">
                <button onclick="createUser()">Thêm User</button>
            </div>
            <table id="userTable">
                <thead>
                    <tr>
                        <th>ID</th><th>Fullname</th><th>Email</th><th>Phone</th><th>Hành động</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
        <section>
            <h2>CRUD Category</h2>
            <div>
                <input id="catName" placeholder="Tên category">
                <div id="catImgDrop" style="display:inline-block;vertical-align:middle;width:220px;height:44px;border:2.5px solid #007bff;border-radius:8px;background:#f4f8ff;color:#007bff;text-align:center;line-height:44px;cursor:pointer;position:relative;font-weight:500;box-shadow:0 2px 8px rgba(0,123,255,0.08);transition:border 0.2s;">
                    Chọn tệp hoặc thả tệp vào đây
                    <input type="file" id="catImgFile" accept="image/*" style="opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer;">
                </div>
                <input type="hidden" id="catImg">
                <img id="catImgPreview" src="" alt="" style="max-height:38px;max-width:60px;vertical-align:middle;margin-left:8px;display:none;">
                <button onclick="createCategory()">Thêm Category</button>
            </div>
            <table id="catTable">
                <thead>
                    <tr>
                        <th>ID</th><th>Name</th><th>Images</th><th>Hành động</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
        <section>
            <h2>CRUD Product</h2>
            <div>
                <input id="prodTitle" placeholder="Tên sản phẩm">
                <input id="prodQty" type="number" placeholder="Số lượng">
                <input id="prodDesc" placeholder="Mô tả">
                <input id="prodPrice" type="number" placeholder="Giá">
                <input id="prodUserId" type="number" placeholder="User ID">
                <input id="prodCatIds" placeholder="Category IDs (cách nhau dấu phẩy)">
                <button onclick="createProduct()">Thêm Product</button>
            </div>
            <table id="prodTable">
                <thead>
                    <tr>
                        <th>ID</th><th>Title</th><th>Price</th><th>Quantity</th><th>User</th><th>Hành động</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </main>
    <footer>
        Họ tên: Nguyễn Thành Huy &nbsp; | &nbsp; MSSV: 23110227
    </footer>
    <script>
    const endpoint = 'http://localhost:8081/graphql';
    // --- USER CRUD ---
    async function fetchUsers() {
        const res = await fetch(endpoint, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ query: '{ allUsers { id fullname email phone } }' })
        });
        const data = await res.json();
        renderUsers(data.data.allUsers);
    }
    function renderUsers(users) {
        const tbody = document.querySelector('#userTable tbody');
        tbody.innerHTML = '';
        users.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${u.id}</td><td>${u.fullname}</td><td>${u.email}</td><td>${u.phone}</td>
            <td><button class="action-btn" onclick="deleteUser(${u.id})">Xóa</button></td>`;
            tbody.appendChild(tr);
        });
    }
    async function createUser() {
        const fullname = document.getElementById('fullname').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const phone = document.getElementById('phone').value;
        await fetch(endpoint, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                query: `mutation($user: UserInput!) { createUser(user: $user) { id } }`,
                variables: { user: { fullname, email, password, phone } }
            })
        });
        fetchUsers();
    }
    async function deleteUser(id) {
        await fetch(endpoint, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ query: `mutation { deleteUser(id: "${id}") }` })
        });
        fetchUsers();
    }
    // --- CATEGORY CRUD ---
    async function fetchCategories() {
        const res = await fetch(endpoint, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ query: '{ allCategories { id name images } }' })
        });
        const data = await res.json();
        renderCategories(data.data.allCategories);
    }
    function renderCategories(cats) {
        const tbody = document.querySelector('#catTable tbody');
        tbody.innerHTML = '';
        cats.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${c.id}</td><td>${c.name}</td><td>${c.images ? `<img src='${c.images}' style='max-width:60px;max-height:38px;border-radius:4px;border:1.5px solid #e3e6ea;background:#fff;'/>` : ''}</td>
            <td><button class="action-btn" onclick="deleteCategory(${c.id})">Xóa</button></td>`;
            tbody.appendChild(tr);
        });
    }
    async function createCategory() {
        const name = document.getElementById('catName').value;
        const images = document.getElementById('catImg').value;
        if (!name.trim() || !images.trim()) {
            alert('Vui lòng nhập tên và chọn ảnh cho category!');
            return;
        }
        await fetch(endpoint, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                query: `mutation($category: CategoryInput!) { createCategory(category: $category) { id } }`,
                variables: { category: { name, images } }
            })
        });
        document.getElementById('catImg').value = '';
        document.getElementById('catImgFile').value = '';
        document.getElementById('catImgPreview').src = '';
        document.getElementById('catImgPreview').style.display = 'none';
        document.getElementById('catName').value = '';
        fetchCategories();
    }

    // Drag & drop/choose file for category image
    const dropZone = document.getElementById('catImgDrop');
    const fileInput = document.getElementById('catImgFile');
    const imgInput = document.getElementById('catImg');
    const imgPreview = document.getElementById('catImgPreview');

    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.style.background = '#e3f0ff';
    });
    dropZone.addEventListener('dragleave', function(e) {
        dropZone.style.background = '#f4f8ff';
    });
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.style.background = '#f4f8ff';
        const file = e.dataTransfer.files[0];
        handleCategoryImageFile(file);
    });
    dropZone.addEventListener('click', function() {
        fileInput.click();
    });
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        handleCategoryImageFile(file);
    });

    function handleCategoryImageFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            imgInput.value = e.target.result;
            imgPreview.src = e.target.result;
            imgPreview.style.display = 'inline-block';
        };
        reader.readAsDataURL(file);
    }
    async function deleteCategory(id) {
        await fetch(endpoint, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ query: `mutation { deleteCategory(id: "${id}") }` })
        });
        fetchCategories();
    }
    // --- PRODUCT CRUD ---
    async function fetchProducts() {
        const res = await fetch(endpoint, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ query: '{ productsByPriceAsc { id title price quantity user { fullname } } }' })
        });
        const data = await res.json();
        renderProducts(data.data.productsByPriceAsc);
    }
    function renderProducts(products) {
        const tbody = document.querySelector('#prodTable tbody');
        tbody.innerHTML = '';
        products.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${p.id}</td><td>${p.title}</td><td>${p.price}</td><td>${p.quantity}</td><td>${p.user ? p.user.fullname : ''}</td>
            <td><button class="action-btn" onclick="deleteProduct(${p.id})">Xóa</button></td>`;
            tbody.appendChild(tr);
        });
    }
    async function createProduct() {
        const title = document.getElementById('prodTitle').value;
        const quantity = parseInt(document.getElementById('prodQty').value);
        const description = document.getElementById('prodDesc').value;
        const price = parseFloat(document.getElementById('prodPrice').value);
        const userId = document.getElementById('prodUserId').value;
        const categoryIds = document.getElementById('prodCatIds').value.split(',').map(s => s.trim()).filter(Boolean);
        await fetch(endpoint, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                query: `mutation($product: ProductInput!) { createProduct(product: $product) { id } }`,
                variables: { product: { title, quantity, description, price, userId, categoryIds } }
            })
        });
        fetchProducts();
    }
    async function deleteProduct(id) {
        await fetch(endpoint, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ query: `mutation { deleteProduct(id: "${id}") }` })
        });
        fetchProducts();
    }
    // --- INIT ---
    fetchUsers();
    fetchCategories();
    fetchProducts();
    </script>
</body>
</html>
